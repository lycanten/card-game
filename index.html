<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- ‡∏™‡πà‡∏ß‡∏ô CSS ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { max-width: 1200px; width: 100%; }
        .card { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #667eea; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .login-form { max-width: 400px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 1.1em; }
        input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; transition: all 0.3s; }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .error-message { background: #fee; color: #c33; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 2px solid #fcc; }
        .cards-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 40px 0; max-width: 800px; margin-left: auto; margin-right: auto; }
        .card-item { aspect-ratio: 2/3; perspective: 1000px; cursor: pointer; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-item.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2em; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .card-front { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .card-back { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); transform: rotateY(180deg); color: white; flex-direction: column; gap: 10px; }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Highlight ‡πÅ‡∏•‡∏∞ Drop ‡∏™‡∏µ */
        .card-item.selected .card-back { border: 4px solid #00f2fe; box-shadow: 0 0 15px rgba(0,242,254,0.5); }
        .card-item.greyed { opacity: 0.5; filter: grayscale(0.8); transition: all 0.5s; }
        
        .capture-area { background: white; padding: 40px; border-radius: 20px; margin: 20px auto; max-width: 500px; }
        .capture-header { color: #667eea; font-size: 2em; margin-bottom: 20px; text-align: center; }
        .capture-username { color: #333; font-size: 1.3em; margin-bottom: 15px; text-align: center; }
        .capture-prize { color: #f5576c; font-size: 3em; font-weight: bold; margin: 20px 0; text-align: center; }
        .capture-code { background: #f5f5f5; padding: 15px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 1.2em; letter-spacing: 2px; color: #333; margin: 20px 0; text-align: center; }
        .capture-footer { color: #999; font-size: 0.9em; margin-top: 20px; text-align: center; }
        .loading { text-align: center; padding: 20px; color: #667eea; font-size: 1.2em; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .instruction { background: #f0f4ff; padding: 20px; border-radius: 10px; margin-bottom: 30px; color: #333; line-height: 1.6; }
        .play-again-btn { margin-top: 20px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        @media (max-width: 768px) { .cards-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_URL = 'https://script.google.com/macros/s/AKfycbwwboStYCdO9rKa8mNR7VsOzryDWm2FuzrJuT6ifoWjvSnv3bDGIWuQHDlDyn31_wA/exec';

        function CardGame() {
            const [stage, setStage] = useState('login');
            const [username, setUsername] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [loadingPrizes, setLoadingPrizes] = useState(false);
            const [cards, setCards] = useState([]);
            const [selectedCard, setSelectedCard] = useState(null);
            const [isFlippingAll, setIsFlippingAll] = useState(false); // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö
            const [prize, setPrize] = useState(null);
            const [code, setCode] = useState('');
            const [realPrize, setRealPrize] = useState(null);

            useEffect(() => {
                if (stage === 'playing' && cards.length === 0 && !loadingPrizes) {
                    fetchPrizes();
                }
            }, [stage]);

            const fetchPrizes = async () => {
                setLoadingPrizes(true);
                try {
                    const response = await fetch(`${API_URL}?action=getPrizes&username=${encodeURIComponent(username.trim())}`);
                    const data = await response.json();
                    if (data.success && data.prizes) {
                        setRealPrize(data.winAmount);
                        setCards(data.prizes.map(amount => ({ amount })));
                    } else {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏û‡πà');
                        setStage('login');
                    }
                } catch (err) {
                    alert('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                    setStage('login');
                } finally {
                    setLoadingPrizes(false);
                }
            };

            const handleLogin = async () => {
                if (!username.trim()) { setError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); return; }
                setLoading(true);
                setError('');
                try {
                    const response = await fetch(`${API_URL}?action=checkUser&username=${encodeURIComponent(username.trim())}`);
                    const data = await response.json();
                    if (data.success) { setStage('playing'); } 
                    else { setError(data.message || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏•‡πà‡∏ô'); }
                } catch (err) { setError('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
                setLoading(false);
            };

            const handleCardClick = async (index) => {
                if (selectedCard !== null) return;

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ---
                // 1. ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ß‡πâ
                const winningAmount = realPrize || cards[index].amount; // ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤
                
                // 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡πÑ‡∏û‡πà‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                const newCards = [...cards];
                
                // 3. ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà
                const hiddenIndex = newCards.findIndex(c => c.amount === winningAmount);
                
                // 4. ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏û‡πà: ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏≤‡∏¢‡∏±‡∏î‡πÉ‡∏™‡πà‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                if (hiddenIndex !== -1 && hiddenIndex !== index) {
                   const temp = newCards[index].amount;
                   newCards[index].amount = winningAmount; // ‡πÉ‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏£‡∏¥‡∏á
                   newCards[hiddenIndex].amount = temp;    // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏õ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
                } else if (hiddenIndex === -1) {
                   // ‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡∏Å‡∏±‡∏ô Error) ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏•‡∏¢
                   newCards[index].amount = winningAmount;
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏û‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                setCards(newCards);
                const selectedPrize = newCards[index]; 
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏ö ---

                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let generatedCode = '';
                for (let i = 0; i < 10; i++) { generatedCode += chars.charAt(Math.floor(Math.random() * chars.length)); }
                
                setSelectedCard(index);
                setPrize(selectedPrize);
                setCode(generatedCode);

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÑ‡∏õ Backend
                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveResult',
                        username: username.trim(),
                        prize: selectedPrize.amount,
                        code: generatedCode
                    })
                });

                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
                setTimeout(() => {
                    setIsFlippingAll(true);
                }, 300);

                setTimeout(() => {
                    setStage('result');
                }, 3300); 
            };

            const handleCapture = async () => {
                const element = document.getElementById('capture-area');
                const canvas = await html2canvas(element, { backgroundColor: '#ffffff', scale: 2 });
                const link = document.createElement('a');
                link.download = `prize-${code}.png`;
                link.href = canvas.toDataURL();
                link.click();
            };

            if (stage === 'login') return (
                <div className="container">
                    <div className="card">
                        <h1>üõ∫  ‡πÄ‡∏Å‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• üõ∫ </h1>
                        <div className="instruction">
                            <strong>üìå ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô:</strong>
                            <ul style={{ marginLeft: '20px', marginTop: '10px' }}>
                                <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö‡∏à‡∏≤‡∏Å 6 ‡πÉ‡∏ö</li>
                                <li>‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 10-1,000 ‡∏ö‡∏≤‡∏ó</li>
                            </ul>
                        </div>
                        {error && <div className="error-message">{error}</div>}
                        <div className="login-form">
                            <div className="form-group">
                                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</label>
                                <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" disabled={loading} />
                            </div>
                            <button className="btn" onClick={handleLogin} disabled={loading}>{loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô'}</button>
                        </div>
                    </div>
                </div>
            );

            if (stage === 'playing') return (
                <div className="container">
                    <div className="card">
                        <h1>üõ∫  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏û‡πà 1 ‡πÉ‡∏ö üõ∫ </h1>
                        <p style={{ textAlign: 'center', marginBottom: '20px' }}>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ <strong>{username}</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏û‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
                        {loadingPrizes ? (
                            <div className="loading"><div className="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏û‡πà...</p></div>
                        ) : (
                            <div className="cards-grid">
                                {cards.map((card, index) => (
                                    <div
                                        key={index}
                                        className={`card-item ${selectedCard === index || isFlippingAll ? 'flipped' : ''} ${selectedCard === index ? 'selected' : ''} ${selectedCard !== null && selectedCard !== index ? 'greyed' : ''}`}
                                        onClick={() => handleCardClick(index)}
                                    >
                                        <div className="card-inner">
                                            <div className="card-front"><span>?</span></div>
                                            <div className="card-back">
                                                <div className="card-value">{card.amount}‡∏ø</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        {selectedCard !== null && <div className="loading"><div className="spinner"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•...</p></div>}
                    </div>
                </div>
            );

            if (stage === 'result') return (
                <div className="container">
                    <div className="card">
                        <h1>üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! üéâ</h1>
                        <div id="capture-area" className="capture-area">
                            <div className="capture-header">üé¥ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏û‡πà üé¥</div>
                            <div className="capture-username">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: {username}</div>
                            <div className="capture-prize">{prize.amount} ‡∏ö‡∏≤‡∏ó</div>
                            <div className="capture-code">‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: {code}</div>
                            <div className="capture-footer">{new Date().toLocaleString('th-TH')}</div>
                        </div>
                        <button className="btn" onClick={handleCapture}>üì∏ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                        <button className="btn play-again-btn" onClick={() => window.open('https://lin.ee/BH9MAK6', '_blank')}>üí¨ ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<CardGame />, document.getElementById('root'));
    </script>
</body>
</html>